# .github/workflows/auto_update_iptv.yml
name: Auto Update IPTV List

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´2ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´10ç‚¹ï¼‰
    - cron: '0 8 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'process_iptv.py'

jobs:
  update-iptv:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»“åº“
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. è®¾ç½®Pythonç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          #cache: 'pip'  # å¯ç”¨pipç¼“å­˜ï¼ŒåŠ é€Ÿåç»­å®‰è£…
      
      # 3. å®‰è£…ä¾èµ–ï¼ˆåŒ…æ‹¬playwrightå’Œrequestsï¼‰
      - name: Install dependencies
        run: |
          pip install requests playwright
          # åªå®‰è£…chromiumï¼Œä¸å®‰è£…firefoxå’Œwebkitä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´
          playwright install chromium --with-deps
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
      
      # 4. è¿è¡Œå¤„ç†è„šæœ¬
      - name: Run IPTV processing script
        run: |
          python process_iptv.py
          echo "ç”Ÿæˆçš„CN.m3uå†…å®¹é¢„è§ˆï¼š"
          head -30 CN.m3u
      
      # 5. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
      - name: Check for changes
        id: changes
        run: |
          git status
          if git diff --quiet CN.m3u 2>/dev/null || [ ! -f CN.m3u ]; then
            echo "æ²¡æœ‰æ£€æµ‹åˆ°å˜åŒ–"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°CN.m3uæ–‡ä»¶æœ‰æ›´æ–°"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      # 6. æäº¤å¹¶æ¨é€æ›´æ”¹ï¼ˆä»…åœ¨æ–‡ä»¶æœ‰å˜åŒ–æ—¶ï¼‰
      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config user.name "takeAChestnut"
          git config user.email "1432726299@qq.com"
          git add CN.m3u
          git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–°IPTVåˆ—è¡¨ [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # 7. æ²¡æœ‰å˜åŒ–æ—¶çš„é€šçŸ¥
      - name: No changes notification
        if: steps.changes.outputs.has_changes == 'false'
        run: echo "âœ… CN.m3uæ–‡ä»¶æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
